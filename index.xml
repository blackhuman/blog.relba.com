<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>August's Blog</title><link>https://www.relba.com/</link><description>Recent content on August's Blog</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Sun, 23 Feb 2020 13:46:31 +8000</lastBuildDate><atom:link href="https://www.relba.com/index.xml" rel="self" type="application/rss+xml"/><item><title>OpenConnect DNS Split 配置</title><link>https://www.relba.com/post/openconnect-dns-split-config/</link><pubDate>Sun, 23 Feb 2020 13:46:31 +8000</pubDate><guid>https://www.relba.com/post/openconnect-dns-split-config/</guid><description>OpenConnect DNS Split 配置 Cisco的VPN连接程序Anyconnect Secure Mobility Client是没有配置任何DNS Split/Route Split的, 也就是在开启后,任何连接,包括DNS解析和所有TCP/IP流量都会从VPN的通道走,而且一般会因为VPN服务端的配置,任何本地局域网的出入流量都会被禁用,这样一来所有的下载(比如BT),和局域网内的服务(如AirDrop/AirPlay/SMB文件服务等依赖局域网联通和FQDN本地域名解析的服务)都不能使用了.幸好有openconnect这个实现了anyconnect协议的工具,我们可以方便的配置本地的路由方案和DNS解析方案.
openconnect 脚本配置原理 默认情况下, openconnect本体程序只负责建立隧道连接,本地的路由规则和DNS解析都不会被配置,但是openconnect提供了用于回调的vpnc-script脚本来负责完成这些事情.vpnc-script脚本是openconnect在完成连接/断开连接等动作后会调用的脚本,而openconnect在编译时就执行了搜索这个脚本的位置,一般来说是/etc/vpnc-script.在MacOS下,有开源的OpenConnect-GUI使用,OpenConnect-GUI是一个将openconnect包装了一层的Mac标准程序,同时OpenConnect-GUI提供了默认的vpnc-script脚本来完成一般类型的初始化工作(主要是路由表的配置),这个vpnc-script脚本被打包进了OpenConnect-GUI程序本身.可以发现,OpenConnect-GUI在启动时会要求一个root权限,这是因为vpnc-script脚本会在root用户权限下被执行.因为openconnect在启动时只能指定一个脚本使用,不过OpenConnect-GUI的vpnc-script脚本留了一个口子,就是它会在执行脚本内容时,搜索在/etc/vpnc/目录下存在的Hooks来调用.通过研究vpnc-script脚本,发现它会在openconnect的不同执行目标下使用不同的Hooks脚本来完成额外的工作.这个对应关系如下:
pre-init -&amp;gt; /etc/vpnc/pre-init.d/*
connect -&amp;gt; /etc/vpnc/connect.d/*
post-connect -&amp;gt; /etc/vpnc/post-connect.d/*
disconnect -&amp;gt; /etc/vpnc/disconnect.d/*
post-disconnect -&amp;gt; /etc/vpnc/post-disconnect.d/*
reconnect -&amp;gt; /etc/vpnc/reconnect.d/*
这样通过添加额外的Hooks脚本就能达成我们定制化的目的.对我来说,我主要要在connect前和disconnect前做一些工作,我创建了一个叫做override-dns-config.sh的脚本,同时放在了connect.d和disconnect.d目录下(通过软连接方式,这样我不必在改动时同时改动两个相同的文件),文件内容如下:
modify_resolvconf_generic() { if [ &amp;#34;$OS&amp;#34; = &amp;#34;Darwin&amp;#34; ]; then case &amp;#34;`uname -r`&amp;#34; in # Skip for pre-10.4 systems 4.*|5.*|6.*|7.*) ;; # 10.4 and later require use of scutil for DNS to work properly *) scutil &amp;gt;/dev/null 2&amp;gt;&amp;amp;1 &amp;lt;&amp;lt;-EOF open d.</description></item><item><title>How to Use Hugo</title><link>https://www.relba.com/post/how-to-use-hugo/</link><pubDate>Wed, 27 Mar 2019 13:46:31 +0000</pubDate><guid>https://www.relba.com/post/how-to-use-hugo/</guid><description/></item><item><title>Github Pages - First Step</title><link>https://www.relba.com/post/github-pages-first-step/</link><pubDate>Tue, 26 Mar 2019 16:00:00 +0000</pubDate><guid>https://www.relba.com/post/github-pages-first-step/</guid><description/></item></channel></rss>