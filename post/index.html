<!doctype html><html lang=zh-cn><head><meta charset=utf-8><title>Posts
| August's Blog</title><link href=//cdn.jsdelivr.net rel=dns-prefetch><link href=//cdnjs.cloudflare.com rel=dns-prefetch><link href=//at.alicdn.com rel=dns-prefetch><link href=//fonts.googleapis.com rel=dns-prefetch><link href=//fonts.gstatic.com rel=dns-prefetch><meta name=twitter:card content="summary"><meta name=twitter:site content="@gohugoio"><meta name=twitter:title content="August's Blog"><meta name=twitter:image content="/images/avatar.png"><meta property="og:type" content="website"><meta property="og:title" content="August's Blog"><meta property="og:url" content="https://www.relba.com/post/"><meta property="og:image" content="/images/avatar.png"><meta name=generator content="Hugo 0.65.0"><link rel=canonical href=https://www.relba.com/post/><link rel=alternate type=application/rss+xml href=https://www.relba.com/post/index.xml title="August's Blog"><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no,email=no,adress=no"><meta http-equiv=cache-control content="no-transform"><meta name=robots content="index,follow"><meta name=referrer content="origin-when-cross-origin"><meta name=theme-color content="#02b875"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=apple-mobile-web-app-title content="August's Blog"><meta name=msapplication-tooltip content="August's Blog"><meta name=msapplication-navbutton-color content="#02b875"><meta name=msapplication-TileColor content="#02b875"><meta name=msapplication-TileImage content="/icons/icon-144x144.png"><link rel=icon href=/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/icons/icon-16x16.png><link rel=icon type=image/png sizes=32x32 href=/icons/icon-32x32.png><link rel=icon sizes=192x192 href=/icons/icon-192x192.png><link rel=apple-touch-icon href=/icons/icon-152x152.png><link rel=manifest href=/manifest.json><link rel=preload href=/styles/main-rendered.min.css as=style><link rel=preload href="https://fonts.googleapis.com/css?family=Lobster" as=style><link rel=preload href=/images/avatar.png as=image><link rel=preload href=/images/grey-prism.svg as=image><style>body{background:#f4f3f1url(/images/grey-prism.svg)repeat fixed}</style><link rel=stylesheet href=/styles/main-rendered.min.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lobster"><!--[if lte IE 8]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><script src=https://cdn.jsdelivr.net/npm/videojs-ie8@1.1.2/dist/videojs-ie8.min.js></script><![endif]--><!--[if lte IE 9]><script src=https://cdn.jsdelivr.net/npm/eligrey-classlist-js-polyfill@1.2.20180112/classList.min.js></script><![endif]--></head><body><div class=suspension><a role=button aria-label="Go to top" title="Go to top" class="to-top is-hide"><span class="icon icon-up" aria-hidden=true></span></a></div><header class=site-header><a href=https://www.relba.com/><img class=avatar src=/images/avatar.png alt=Avatar></a><h2 class=title><a href=https://www.relba.com/>August's Blog</a></h2><p class=subtitle></p><button class=menu-toggle type=button aria-label="Main Menu" aria-expanded=false tab-index=0>
<span class="icon icon-menu" aria-hidden=true></span></button><nav class="site-menu collapsed"><h2 class=offscreen>Main Menu</h2><ul class=menu-list></ul></nav><nav class="social-menu collapsed"><h2 class=offscreen>Social Networks</h2><ul class=social-list></ul></nav></header><section class="main post-list"><header class="list-header offscreen"><h2 class=list-label>Posts List</h2></header><article class=post-entry><header class=post-header><h3 class=post-title><a href=https://www.relba.com/post/how-to-use-hugo/ class=post-link>How to Use Hugo</a></h3><p class=post-meta>@ · Mar 27, 2019 · 0 min read</p></header><p class=post-summary></p><footer class=post-footer><a class=read-more href=https://www.relba.com/post/how-to-use-hugo/>Read More →</a></footer></article><article class=post-entry><header class=post-header><h3 class=post-title><a href=https://www.relba.com/post/github-pages-first-step/ class=post-link>Github Pages - First Step</a></h3><p class=post-meta>@ · Mar 26, 2019 · 0 min read</p></header><p class=post-summary></p><footer class=post-footer><a class=read-more href=https://www.relba.com/post/github-pages-first-step/>Read More →</a></footer></article><article class=post-entry><header class=post-header><h3 class=post-title><a href=https://www.relba.com/post/openconnect-dns-split-config/ class=post-link></a></h3><p class=post-meta>@ · Jan 1, 0001 · 2 min read</p></header><p class=post-summary>OpenConnect DNS Split 配置 Cisco的VPN连接程序Anyconnect Secure Mobility Client是没有配置任何DNS Split/Route Split的, 也就是在开启后,任何连接,包括DNS解析和所有TCP/IP流量都会从VPN的通道走,而且一般会因为VPN服务端的配置,任何本地局域网的出入流量都会被禁用,这样一来所有的下载(比如BT),和局域网内的服务(如AirDrop/AirPlay/SMB文件服务等依赖局域网联通和FQDN本地域名解析的服务)都不能使用了.幸好有openconnect这个实现了anyconnect协议的工具,我们可以方便的配置本地的路由方案和DNS解析方案.
openconnect 脚本配置原理 默认情况下, openconnect本体程序只负责建立隧道连接,本地的路由规则和DNS解析都不会被配置,但是openconnect提供了用于回调的vpnc-script脚本来负责完成这些事情.vpnc-script脚本是openconnect在完成连接/断开连接等动作后会调用的脚本,而openconnect在编译时就执行了搜索这个脚本的位置,一般来说是/etc/vpnc-script.在MacOS下,有开源的OpenConnect-GUI使用,OpenConnect-GUI是一个将openconnect包装了一层的Mac标准程序,同时OpenConnect-GUI提供了默认的vpnc-script脚本来完成一般类型的初始化工作(主要是路由表的配置),这个vpnc-script脚本被打包进了OpenConnect-GUI程序本身.可以发现,OpenConnect-GUI在启动时会要求一个root权限,这是因为vpnc-script脚本会在root用户权限下被执行.因为openconnect在启动时只能指定一个脚本使用,不过OpenConnect-GUI的vpnc-script脚本留了一个口子,就是它会在执行脚本内容时,搜索在/etc/vpnc/目录下存在的Hooks来调用.通过研究vpnc-script脚本,发现它会在openconnect的不同执行目标下使用不同的Hooks脚本来完成额外的工作.这个对应关系如下:
pre-init -> /etc/vpnc/pre-init.d/*
connect -> /etc/vpnc/connect.d/*
post-connect -> /etc/vpnc/post-connect.d/*
disconnect -> /etc/vpnc/disconnect.d/*
post-disconnect -> /etc/vpnc/post-disconnect.d/*
reconnect -> /etc/vpnc/reconnect.d/*
这样通过添加额外的Hooks脚本就能达成我们定制化的目的.对我来说,我主要要在connect前和disconnect前做一些工作,我创建了一个叫做override-dns-config.sh的脚本,同时放在了connect.d和disconnect.d目录下(通过软连接方式,这样我不必在改动时同时改动两个相同的文件),文件内容如下:
modify_resolvconf_generic() { if [ "$OS" = "Darwin" ]; then case "`uname -r`" in # Skip for pre-10.4 systems 4.*|5.*|6.*|7.*) ;; # 10.4 and later require use of scutil for DNS to work properly *) scutil >/dev/null 2>&1 &lt;&lt;-EOF open d.</p><footer class=post-footer><a class=read-more href=https://www.relba.com/post/openconnect-dns-split-config/>Read More →</a></footer></article></section><footer class=site-footer><p>© 2017-2020 August's Blog</p><p>Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> with theme <a href=https://github.com/laozhu/hugo-nuo target=_blank rel=noopener>Nuo</a>.</p></footer><script src=https://cdn.jsdelivr.net/npm/smooth-scroll@15.0.0/dist/smooth-scroll.min.js></script><script src=/scripts/index.min.js></script><script>if('serviceWorker'in navigator){navigator.serviceWorker.register('\/service-worker.js').then(function(){console.log('[ServiceWorker] Registered');});}</script></body></html>