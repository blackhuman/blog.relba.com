<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>August's Blog | dns</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=generator content="Hugo 0.65.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link href=/dist/css/app.1cb140d8ba31d5b2f1114537dd04802a.css rel=stylesheet><link href=/tags/dns/index.xml rel=alternate type=application/rss+xml title="August's Blog"><link href=/tags/dns/index.xml rel=feed type=application/rss+xml title="August's Blog"><meta property="og:title" content="dns"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://www.relba.com/tags/dns/"><meta property="og:updated_time" content="2020-02-23T13:46:31+80:00"><meta itemprop=name content="dns"><meta itemprop=description content><meta name=twitter:card content="summary"><meta name=twitter:title content="dns"><meta name=twitter:description content></head><body class="ma0 avenir bg-near-white"><header><div class="pb3-m pb6-l bg-black"><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=https://www.relba.com/ class="f3 fw2 hover-white no-underline white-90 dib">August's Blog</a><div class="flex-l items-center"></div></div></nav><div class="tc-l pv3 ph3 ph4-ns"><h1 class="f2 f-subheadline-l fw2 light-silver mb0 lh-title">dns</h1></div></div></header><main class=pb7 role=main><article class="cf pa3 pa4-m pa4-l"><div class="measure-wide-l center f4 lh-copy nested-copy-line-height nested-links nested-img mid-gray"><p>Below you will find pages that utilize the taxonomy term “dns”</p></div></article><div class="mw8 center"><section class="flex-ns flex-wrap justify-around mt5"><div class="relative w-100 mb4 bg-white"><div class="relative w-100 mb4 bg-white nested-copy-line-height"><div class="bg-white mb3 pa4 gray overflow-hidden"><span class="f6 db">Post</span><h1 class="f3 near-black"><a href=https://www.relba.com/post/openconnect-dns-split-config/ class="link black dim">OpenConnect DNS Split 配置</a></h1><div class="nested-links f5 lh-copy nested-copy-line-height">OpenConnect DNS Split 配置 Cisco的VPN连接程序Anyconnect Secure Mobility Client是没有配置任何DNS Split/Route Split的, 也就是在开启后,任何连接,包括DNS解析和所有TCP/IP流量都会从VPN的通道走,而且一般会因为VPN服务端的配置,任何本地局域网的出入流量都会被禁用,这样一来所有的下载(比如BT),和局域网内的服务(如AirDrop/AirPlay/SMB文件服务等依赖局域网联通和FQDN本地域名解析的服务)都不能使用了.幸好有openconnect这个实现了anyconnect协议的工具,我们可以方便的配置本地的路由方案和DNS解析方案.
openconnect 脚本配置原理 默认情况下, openconnect本体程序只负责建立隧道连接,本地的路由规则和DNS解析都不会被配置,但是openconnect提供了用于回调的vpnc-script脚本来负责完成这些事情.vpnc-script脚本是openconnect在完成连接/断开连接等动作后会调用的脚本,而openconnect在编译时就执行了搜索这个脚本的位置,一般来说是/etc/vpnc-script.在MacOS下,有开源的OpenConnect-GUI使用,OpenConnect-GUI是一个将openconnect包装了一层的Mac标准程序,同时OpenConnect-GUI提供了默认的vpnc-script脚本来完成一般类型的初始化工作(主要是路由表的配置),这个vpnc-script脚本被打包进了OpenConnect-GUI程序本身.可以发现,OpenConnect-GUI在启动时会要求一个root权限,这是因为vpnc-script脚本会在root用户权限下被执行.因为openconnect在启动时只能指定一个脚本使用,不过OpenConnect-GUI的vpnc-script脚本留了一个口子,就是它会在执行脚本内容时,搜索在/etc/vpnc/目录下存在的Hooks来调用.通过研究vpnc-script脚本,发现它会在openconnect的不同执行目标下使用不同的Hooks脚本来完成额外的工作.这个对应关系如下:
pre-init -> /etc/vpnc/pre-init.d/*
connect -> /etc/vpnc/connect.d/*
post-connect -> /etc/vpnc/post-connect.d/*
disconnect -> /etc/vpnc/disconnect.d/*
post-disconnect -> /etc/vpnc/post-disconnect.d/*
reconnect -> /etc/vpnc/reconnect.d/*
这样通过添加额外的Hooks脚本就能达成我们定制化的目的.对我来说,我主要要在connect前和disconnect前做一些工作,我创建了一个叫做override-dns-config.sh的脚本,同时放在了connect.d和disconnect.d目录下(通过软连接方式,这样我不必在改动时同时改动两个相同的文件),文件内容如下:
modify_resolvconf_generic() { if [ "$OS" = "Darwin" ]; then case "`uname -r`" in # Skip for pre-10.4 systems 4.*|5.*|6.*|7.*) ;; # 10.4 and later require use of scutil for DNS to work properly *) scutil >/dev/null 2>&1 &lt;&lt;-EOF open d.</div></div></div></div></section></div></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://www.relba.com/>&copy; August's Blog 2020</a><div></div></div></footer><script src=/dist/js/app.3fc0f988d21662902933.js></script></body></html>